import{commentModel}from"comment-model";import{handlebarsSubstr}from"handlebars-substr";import{htmlHandler}from"html-handler";import{reviewModel}from"review-model";import{reviewSort}from"review-sort";import{templateHandler}from"template-handler";import{uploadImg}from"img-upload";import{userControl}from"user-controls";import{validator}from"validator";class ReviewController{loadCreateReviewPage(e){reviewModel.isUserLoggedIn().then(t=>{t?htmlHandler.setHtml("create-review","#content").then(()=>{validator.validateReview()}):e.redirect("#/home")})}createReview(e){const t=reviewModel.getCurrentUser(),o=new Date;let a=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];uploadImg.uploadToApi($("#image")[0].files[0]).then(r=>{const l={author:t.displayName,authorUid:t.uid,image:r.data.link,category:$("#category").val(),title:e.params.title,content:e.params.content,month:a[o.getMonth()],day:o.getDate(),bookTitle:$("#bookTitle").val().toUpperCase()};reviewModel.create(l),e.redirect("#/home")})}loadHomePage(e){const t=e.params.pageSize,o=e.params.page;reviewModel.getAllReviews().then(e=>{const a=Math.ceil(Object.keys(e).length/t),r=Array.from({length:a},(e,t)=>t+1);let l=reviewSort.sortByDate(e),n=reviewSort.sortByPageAndPageSize(o,t,l);templateHandler.setTemplate("home.template","#content",{reviews:n,countPages:a,pageNumbers:r,pageSize:t,pagination:!0})}).catch(e=>{console.log(e)})}loadCategory(e){const t=e.params.pageSize,o=e.params.page,a=e.params.category;reviewModel.getReviews({prop:"category",value:e.params.category}).then(e=>{let r=!1;const l=Math.ceil(Object.keys(e).length/t);Array.from({length:l},(e,t)=>t+1);let n=reviewSort.sortByDate(e),i=reviewSort.sortByPageAndPageSize(o,t,n);l>1&&(r=!0),templateHandler.setTemplate("category.template","#content",{reviews:i,category:a,countPages:l,pageSize:t,pagination:r,activePage:o})}).catch(e=>{console.log(e)})}loadReview(e){let t,o;reviewModel.isUserLoggedIn().then(e=>o=!!e),reviewModel.getReview(e.params.id).then(e=>(t=e,t.author=t.author.toUpperCase(),t)).then(()=>commentModel.getComments({prop:"review",value:t.authorUid+t.title})).then(e=>{let a=0;e&&(a=Object.keys(e).length),templateHandler.setTemplate("review.template","#content",{review:t,comments:e,commentsCount:a,isLoged:o,category:t.category.toLowerCase()})}).catch(e=>{console.log(e)})}createComment(e){let t=reviewModel.getCurrentUser();const o=new Date;let a=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];const r={author:t.displayName,image:t.photoURL,content:$("#comment-box").val(),review:e.params.id,month:a[o.getMonth()],day:o.getDate()};commentModel.create(r),e.redirect("#/home/review/"+e.params.id)}searchByTitle(e){const t=$("#search-input").val();console.log(t);const o=e.params.page,a=e.params.pageSize;reviewModel.getReviews({prop:"bookTitle",value:t}).then(e=>{console.log(e);let t=!1;const r=Math.ceil(Object.keys(e).length/a),l=Array.from({length:r},(e,t)=>t+1);let n=reviewSort.sortByDate(e),i=reviewSort.sortByPageAndPageSize(o,a,n);r>1&&(t=!0),templateHandler.setTemplate("search.result.template","#content",{reviews:i,countPages:r,pageNumbers:l,pageSize:a,pagination:t})})}}const reviewController=new ReviewController;export{reviewController};