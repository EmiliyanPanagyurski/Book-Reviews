import{commentModel}from"comment-model";import{htmlHandler}from"html-handler";import{reviewModel}from"review-model";import{reviewSort}from"review-sort";import{templateHandler}from"template-handler";import{uploadImg}from"img-upload";import{userControl}from"user-controls";import{validator}from"validator";class ReviewController{constructor(e,t,o,r,a){this.reviewModel=e,this.commentModel=t,this.validator=o,this.uploadImg=r}loadCreateReviewPage(e){reviewModel.isUserLoggedIn().then(t=>{t?htmlHandler.setHtml("create-review","#content").then(()=>{validator.validateReview()}):e.redirect("#/home")})}createReview(e){const t=reviewModel.getCurrentUser(),o=new Date;let r=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];uploadImg.uploadToApi($("#image")[0].files[0]).then(a=>{const l={author:t.displayName,authorUid:t.uid,image:a.data.link,category:$("#category").val(),title:e.params.title,content:e.params.content,month:r[o.getMonth()],day:o.getDate()};reviewModel.create(l),e.redirect("#/home")})}loadHomePage(e){const t=e.params.pageSize,o=e.params.page;reviewModel.getAllReviews().then(e=>{const r=Math.ceil(Object.keys(e).length/t),a=Array.from({length:r},(e,t)=>t+1);let l=reviewSort.sortByDate(e),i=reviewSort.sortByPageAndPageSize(o,t,l);templateHandler.setTemplate("home.template","#content",{reviews:i,countPages:r,pageNumbers:a,pageSize:t,pagination:!0})}).catch(e=>{console.log(e)})}loadCategory(e){const t=e.params.pageSize,o=e.params.page,r=e.params.category;reviewModel.getReviews({prop:"category",value:e.params.category}).then(e=>{let a=!1;const l=Math.round(Object.keys(e).length/t);Array.from({length:l},(e,t)=>t+1);let i=reviewSort.sortByDate(e),n=reviewSort.sortByPageAndPageSize(o,t,i);l>1&&(a=!0),templateHandler.setTemplate("category.template","#content",{reviews:n,category:r,countPages:l,pageSize:t,pagination:a})}).catch(e=>{console.log(e)})}loadReview(e){let t,o;reviewModel.isUserLoggedIn().then(e=>o=!!e),reviewModel.getReview(e.params.id).then(e=>(t=e,t.author=t.author.toUpperCase(),t)).then(()=>commentModel.getComments({prop:"review",value:t.authorUid+t.title})).then(e=>{let r=0;e&&(r=Object.keys(e).length),templateHandler.setTemplate("review.template","#content",{review:t,comments:e,commentsCount:r,isLoged:o,category:t.category.toLowerCase()})}).catch(e=>{console.log(e)})}createComment(e){let t=reviewModel.getCurrentUser();const o=new Date;let r=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];const a={author:t.displayName,image:t.photoURL,content:$("#comment-box").val(),review:e.params.id,month:r[o.getMonth()],day:o.getDate()};commentModel.create(a),e.redirect("#/home/review/"+e.params.id)}}const reviewController=new ReviewController(reviewModel,commentModel,validator,uploadImg);export{reviewController};